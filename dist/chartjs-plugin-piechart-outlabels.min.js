/*!
 * chartjs-plugin-piechart-outlabels v0.1.3
 * http://www.chartjs.org
 * (c) 2017-2022 chartjs-plugin-piechart-outlabels contributors
 * Released under the MIT license
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("chart.js"),require("chart.js/helpers")):"function"==typeof define&&define.amd?define(["chart.js","chart.js/helpers"],e):(t="undefined"!=typeof globalThis?globalThis:t||self).ChartPieChartOutlabels=e(t.Chart,t.Chart.helpers)}(this,(function(t,e){"use strict";var i={LABEL_KEY:"$outlabels",backgroundColor:function(t){return t.dataset.backgroundColor},borderColor:function(t){return t.dataset.backgroundColor},lineColor:function(t){return t.dataset.backgroundColor},borderRadius:0,borderWidth:0,lineWidth:2,color:"white",display:!0,font:{family:void 0,size:void 0,style:void 0,weight:null,maxSize:null,minSize:null,resizable:!0},lineHeight:1.2,padding:{top:4,right:4,bottom:4,left:4},textAlign:"center",stretch:40,horizontalStrechPad:40,text:"%l %p",zoomOutPercentage:50,percentPrecision:1,valuePrecision:3},s=function(t,e){var i=(t.startAngle+t.endAngle)/2,s=Math.cos(i),h=Math.sin(i),r=t.outerRadius,n=r+e;return{x:t.x+s*n,y:t.y+h*n,d:n,arc:t,anchor:{x:t.x+s*r,y:t.y+h*r},copy:{x:t.x+s*n,y:t.y+h*n}}},h=function(t,e){var i=t.arc,s=t.d,h=(i.startAngle+i.endAngle)/2,r=Math.cos(h),n=Math.sin(h);return s+=e,{x:i.x+r*s,y:i.y+n*s,d:s,arc:i,anchor:t.anchor,copy:{x:i.x+r*s,y:i.y+n*s}}};function r(i,s){var h=e.valueOrDefault(i.size,t.Chart.defaults.defaultFontSize);i.resizable&&(h=function(t,e,i){var s=t/100*2.5;return e&&s<e?e:i&&s>i?i:s}(s,i.minSize,i.maxSize));var r={family:e.valueOrDefault(i.family,t.Chart.defaults.defaultFontFamily),lineHeight:e.toLineHeight(i.lineHeight,h),size:h,style:e.valueOrDefault(i.style,t.Chart.defaults.defaultFontStyle),weight:e.valueOrDefault(i.weight,null),string:""};return r.string=function(t){return!t||e.isNullOrUndef(t.size)||e.isNullOrUndef(t.family)?null:(t.style?t.style+" ":"")+(t.weight?t.weight+" ":"")+t.size+"px "+t.family}(r),r}var n=i.LABEL_KEY,l=function(t,l,o,a,c){if(!e.resolve([a.display,!0],c,l))throw new Error("Label display property is set to false.");var d=c.dataset.data[l],f=c.labels[l],x=e.resolve([a.text,i.text],c,l);((x=x.replace(/%l/gi,f)).match(/%v\.?(\d*)/gi)||[]).map((function(t){var e=t.replace(/%v\./gi,"");return e.length?+e:a.valuePrecision||i.valuePrecision})).forEach((function(t){x=x.replace(/%v\.?(\d*)/i,d.toFixed(t))})),(x.match(/%p\.?(\d*)/gi)||[]).map((function(t){var e=t.replace(/%p\./gi,"");return e.length?+e:a.percentPrecision||i.percentPrecision})).forEach((function(t){x=x.replace(/%p\.?(\d*)/i,(100*c.percent).toFixed(t)+"%")}));var u=x.match(/[^\r\n]+/g);if(!u||!u.length)throw new Error("No text to show.");for(var y=0;y<u.length;++y)u[y]=u[y].trim();this.init=function(s,h){this.encodedText=a.text,this.text=s,this.lines=h,this.label=f,this.value=d,this.ctx=o,this.style={backgroundColor:e.resolve([a.backgroundColor,i.backgroundColor,"black"],c,l),borderColor:e.resolve([a.borderColor,i.borderColor,"black"],c,l),borderRadius:e.resolve([a.borderRadius,0],c,l),borderWidth:e.resolve([a.borderWidth,0],c,l),lineWidth:e.resolve([a.lineWidth,2],c,l),lineColor:e.resolve([a.lineColor,i.lineColor,"black"],c,l),color:e.resolve([a.color,"white"],c,l),font:r(e.resolve([a.font,{resizable:!0}]),o.canvas.style.height.slice(0,-2)),padding:e.toPadding(e.resolve([a.padding,0],c,l)),textAlign:e.resolve([a.textAlign,"left"],c,l)},this.stretch=e.resolve([a.stretch,40],c,l),this.horizontalStrechPad=e.resolve([a.horizontalStrechPad,40],c,l),this.size=function(t,e,i){var s,h=[].concat(e),r=h.length,n=t.font,l=0;for(t.font=i.string,s=0;s<r;++s)l=Math.max(t.measureText(h[s]).width,l);return t.font=n,{height:r*i.lineHeight,width:l}}(o,this.lines,this.style.font),this.offsetStep=this.size.width/20,this.offset={x:0,y:0},this.predictedOffset=this.offset;var n=-(t.startAngle+t.endAngle)/2/Math.PI,x=Math.abs(n-Math.trunc(n));x>.45&&x<.55?this.predictedOffset.x=0:n<=.45&&n>=-.45?this.predictedOffset.x=this.size.width/2:n>=-1.45&&n<=-.55&&(this.predictedOffset.x=-this.size.width/2)},this.init(x,u),this.computeLabelRect=function(){var t=this.textRect.width+2*this.style.borderWidth+2*this.style.padding.left,e=this.textRect.height+2*this.style.borderWidth;return{x:this.textRect.x-this.style.borderWidth,y:this.textRect.y-this.style.borderWidth,width:t,height:e}},this.computeTextRect=function(){const t=(this.center.x-this.center.anchor.x<0?-1:1)*this.horizontalStrechPad;return{x:this.center.x-this.size.width/2-this.style.padding.left+t,y:this.center.y-this.size.height/2-this.style.padding.top,width:this.size.width,height:this.size.height+this.style.padding.height}},this.getPoints=function(){return[{x:this.labelRect.x,y:this.labelRect.y},{x:this.labelRect.x+this.labelRect.width,y:this.labelRect.y},{x:this.labelRect.x+this.labelRect.width,y:this.labelRect.y+this.labelRect.height},{x:this.labelRect.x,y:this.labelRect.y+this.labelRect.height}]},this.containsPoint=function(t,e){return e||(e=5),this.labelRect.x-e<=t.x&&t.x<=this.labelRect.x+this.labelRect.width+e&&this.labelRect.y-e<=t.y&&t.y<=this.labelRect.y+this.labelRect.height+e},this.drawText=function(){var t,e,i,s=this.style.textAlign,h=this.style.font.lineHeight,r=this.style.color,n=this.lines.length;if(n&&r)for(t=this.textRect.x,e=this.textRect.y+h/2,"center"===s?t+=this.textRect.width/2:"end"!==s&&"right"!==s||(t+=this.textRect.width),this.ctx.font=this.style.font.string,this.ctx.fillStyle=r,this.ctx.textAlign=s,this.ctx.textBaseline="middle",i=0;i<n;++i)this.ctx.fillText(this.lines[i],Math.round(t)+this.style.padding.left,Math.round(e)+this.style.padding.top,Math.round(this.textRect.width)),e+=h},this.drawLabel=function(){o.beginPath(),this.ctx.fillRect(this.ctx,Math.round(this.labelRect.x),Math.round(this.labelRect.y),Math.round(this.labelRect.width),Math.round(this.labelRect.height),this.style.borderRadius),this.ctx.closePath(),this.style.backgroundColor&&(this.ctx.fillStyle=this.style.backgroundColor||"black",this.ctx.fill()),this.style.borderColor&&this.style.borderWidth&&(this.ctx.strokeStyle=this.style.borderColor,this.ctx.lineWidth=this.style.borderWidth,this.ctx.lineJoin="miter",this.ctx.stroke())},this.ccw=function(t,e,i){return(i.y-t.y)*(e.x-t.x)>(e.y-t.y)*(i.x-t.x)},this.intersects=function(t,e,i,s){return this.ccw(t,i,s)!==this.ccw(e,i,s)&&this.ccw(t,e,i)!==this.ccw(t,e,s)},this.drawLine=function(){this.ctx.save(),this.ctx.strokeStyle=this.style.lineColor,this.ctx.lineWidth=this.style.lineWidth,this.ctx.lineJoin="miter",this.ctx.beginPath(),this.ctx.moveTo(this.center.anchor.x,this.center.anchor.y),this.ctx.lineTo(this.center.copy.x,this.center.copy.y),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(this.center.copy.x,this.center.copy.y);const t=this.textRect.width+this.style.padding.width,e=this.intersects(this.textRect,{x:this.textRect.x+this.textRect.width,y:this.textRect.y+this.textRect.height},this.center.copy,{x:this.textRect.x,y:this.textRect.y+this.textRect.height/2});this.ctx.lineTo(this.textRect.x+(e?t:0),this.textRect.y+this.textRect.height/2),this.ctx.stroke(),this.ctx.restore()},this.draw=function(){this.drawLabel(),this.drawText()},this.update=function(t,e,i){this.center=s(t,this.stretch),this.moveLabelToOffset(),this.center.x+=this.offset.x,this.center.y+=this.offset.y;for(var r=!1;!r;){this.textRect=this.computeTextRect(),this.labelRect=this.computeLabelRect();var l=this.getPoints();r=!0;for(var o=0;o<i;++o){var a=e[o][n];if(a)for(var c=a.getPoints(),d=0;d<l.length;++d){if(a.containsPoint(l[d])){r=!1;break}if(this.containsPoint(c[d])){r=!1;break}}}r||(this.center=h(this.center,1),this.center.x+=this.offset.x,this.center.y+=this.offset.y)}},this.moveLabelToOffset=function(){this.predictedOffset.x<=0&&this.offset.x>this.predictedOffset.x?(this.offset.x-=this.offsetStep,this.offset.x<=this.predictedOffset.x&&(this.offset.x=this.predictedOffset.x)):this.predictedOffset.x>=0&&this.offset.x<this.predictedOffset.x&&(this.offset.x+=this.offsetStep,this.offset.x>=this.predictedOffset.x&&(this.offset.x=this.predictedOffset.x))}};t.defaults.plugins.outlabels=i;var o=i.LABEL_KEY;return{id:"outlabels",resize:function(t){t.sizeChanged=!0},afterUpdate:t=>{const e=t._metasets[0].controller;var s=e.getMeta(),h=t.options.zoomOutPercentage||i.zoomOutPercentage;e.outerRadius*=1-h/100,e.innerRadius*=1-h/100,e.updateElements(s.data,0,s.data.length,"resize")},afterDatasetUpdate:function(t,e,i){var s,h,r,n,a,c,d=t.config.data.labels,f=t.data.datasets[e.index],x=function(t,e){var i=t.outlabels;return!1===i?null:(!0===i&&(i={}),Object.assign({},{},e,i))}(f,i),u=x&&x.display,y=e.meta.data||[],g=t.ctx;for(g.save(),c=0;c<y.length;++c){if(h=(s=y[c])[o],r=f.data[c]/e.meta.total,n=null,u&&s&&!s.hidden)try{a={chart:t,dataIndex:c,dataset:f,labels:d,datasetIndex:e.index,percent:r},n=new l(s,c,g,x,a)}catch(t){n=null}h&&n&&!t.sizeChanged&&h.label===n.label&&h.encodedText===n.encodedText&&(n.offset=h.offset),s[o]=n}g.restore(),t.sizeChanged=!1},afterDatasetDraw:function(t,e){for(var i,s,h=e.meta.data||[],r=t.ctx,n=0;n<2*h.length;++n)(s=(i=h[n<h.length?n:n-h.length])[o])&&(n<h.length?(s.update(i,h,n),s.drawLine(r)):s.draw(r))}}}));
