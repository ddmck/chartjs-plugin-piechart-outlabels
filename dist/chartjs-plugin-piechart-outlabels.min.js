/*!
 * chartjs-plugin-piechart-outlabels v0.1.3
 * http://www.chartjs.org
 * (c) 2017-2022 chartjs-plugin-piechart-outlabels contributors
 * Released under the MIT license
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("chart.js"),require("chart.js/helpers")):"function"==typeof define&&define.amd?define(["chart.js","chart.js/helpers"],e):(t="undefined"!=typeof globalThis?globalThis:t||self).ChartPieChartOutlabels=e(t.Chart,t.Chart.helpers)}(this,(function(t,e){"use strict";var i={LABEL_KEY:"$outlabels",backgroundColor:function(t){return t.dataset.backgroundColor},borderColor:function(t){return t.dataset.backgroundColor},lineColor:function(t){return t.dataset.backgroundColor},borderRadius:0,borderWidth:0,lineWidth:2,color:"white",display:!0,font:{family:void 0,size:void 0,style:void 0,weight:null,maxSize:null,minSize:null,resizable:!0},lineHeight:1.2,padding:{top:4,right:4,bottom:4,left:4},textAlign:"center",stretch:30,horizontalStrechPad:20,text:"%l %p",zoomOutPercentage:10,percentPrecision:1,valuePrecision:3},s=function(t,e){var i=(t.startAngle+t.endAngle)/2,s=Math.cos(i),h=Math.sin(i),r=t.outerRadius,l=r+e;return{x:t.x+s*l,y:t.y+h*l,d:l,arc:t,anchor:{x:t.x+s*r,y:t.y+h*r},copy:{x:t.x+s*l,y:t.y+h*l}}},h=function(t,e){var i=t.arc,s=t.d,h=(i.startAngle+i.endAngle)/2,r=Math.cos(h),l=Math.sin(h);return s+=e,{x:i.x+r*s,y:i.y+l*s,d:s,arc:i,anchor:t.anchor,copy:{x:i.x+r*s,y:i.y+l*s}}};function r(i,s){var h=e.valueOrDefault(i.size,t.Chart.defaults.defaultFontSize);i.resizable&&(h=function(t,e,i){var s=t/100*2.5;return e&&s<e?e:i&&s>i?i:s}(s,i.minSize,i.maxSize));var r={family:e.valueOrDefault(i.family,t.Chart.defaults.defaultFontFamily),lineHeight:e.toLineHeight(i.lineHeight,h),size:h,style:e.valueOrDefault(i.style,t.Chart.defaults.defaultFontStyle),weight:e.valueOrDefault(i.weight,null),string:""};return r.string=function(t){return!t||e.isNullOrUndef(t.size)||e.isNullOrUndef(t.family)?null:(t.style?t.style+" ":"")+(t.weight?t.weight+" ":"")+t.size+"px "+t.family}(r),r}var l=i.LABEL_KEY,n=function(t,n,a,o,c){if(!e.resolve([o.display,!0],c,n))throw new Error("Label display property is set to false.");var d=c.dataset.data[n],u=c.labels[n],x=e.resolve([o.text,i.text],c,n);((x=x.replace(/%l/gi,u)).match(/%v\.?(\d*)/gi)||[]).map((function(t){var e=t.replace(/%v\./gi,"");return e.length?+e:o.valuePrecision||i.valuePrecision})).forEach((function(t){x=x.replace(/%v\.?(\d*)/i,d.toFixed(t))})),(x.match(/%p\.?(\d*)/gi)||[]).map((function(t){var e=t.replace(/%p\./gi,"");return e.length?+e:o.percentPrecision||i.percentPrecision})).forEach((function(t){x=x.replace(/%p\.?(\d*)/i,(100*c.percent).toFixed(t)+"%")}));var f=x.match(/[^\r\n]+/g);if(!f||!f.length)throw new Error("No text to show.");for(var y=0;y<f.length;++y)f[y]=f[y].trim();this.init=function(t,s){this.encodedText=o.text,this.text=t,this.lines=s,this.label=u,this.value=d,this.ctx=a,this.style={backgroundColor:e.resolve([o.backgroundColor,i.backgroundColor,"black"],c,n),borderColor:e.resolve([o.borderColor,i.borderColor,"black"],c,n),borderRadius:e.resolve([o.borderRadius,0],c,n),borderWidth:e.resolve([o.borderWidth,0],c,n),lineWidth:e.resolve([o.lineWidth,2],c,n),lineColor:e.resolve([o.lineColor,i.lineColor,"black"],c,n),color:e.resolve([o.color,"white"],c,n),font:r(e.resolve([o.font,{resizable:!0}]),a.canvas.style.height.slice(0,-2)),padding:e.toPadding(e.resolve([o.padding,0],c,n)),textAlign:e.resolve([o.textAlign,"left"],c,n)},this.stretch=e.resolve([o.stretch,i.stretch],c,n),this.horizontalStrechPad=e.resolve([o.horizontalStrechPad,i.horizontalStrechPad],c,n),this.size=function(t,e,i){var s,h=[].concat(e),r=h.length,l=t.font,n=0;for(t.font=i.string,s=0;s<r;++s)n=Math.max(t.measureText(h[s]).width,n);return t.font=l,{height:r*i.lineHeight,width:n}}(a,this.lines,this.style.font),this.offsetStep=this.size.width/20,this.offset={x:0,y:0}},this.init(x,f),this.computeLabelRect=function(){var t=this.textRect.width+2*this.style.borderWidth+2*this.style.padding.left,e=this.textRect.height+2*this.style.borderWidth;return{x:this.textRect.x-this.style.borderWidth,y:this.textRect.y-this.style.borderWidth,width:t,height:e}},this.computeTextRect=function(){const t=this.center.x-this.center.anchor.x<0?-(this.horizontalStrechPad+this.size.width):this.horizontalStrechPad;return{x:this.center.x-0*this.size.width-this.style.padding.left+t,y:this.center.y-this.size.height/2-this.style.padding.top,width:this.size.width,height:this.size.height+this.style.padding.height}},this.getPoints=function(){return[{x:this.labelRect.x,y:this.labelRect.y},{x:this.labelRect.x+this.labelRect.width,y:this.labelRect.y},{x:this.labelRect.x+this.labelRect.width,y:this.labelRect.y+this.labelRect.height},{x:this.labelRect.x,y:this.labelRect.y+this.labelRect.height}]},this.containsPoint=function(t){return this.labelRect.x-5<=t.x&&t.x<=this.labelRect.x+this.labelRect.width+5&&this.labelRect.y-5<=t.y&&t.y<=this.labelRect.y+this.labelRect.height+5},this.drawText=function(){var t,e,i,s=this.style.textAlign,h=this.style.font.lineHeight,r=this.style.color,l=this.lines.length;if(l&&r)for(t=this.textRect.x,e=this.textRect.y+h/2,"center"===s?t+=this.textRect.width/2:"end"!==s&&"right"!==s||(t+=this.textRect.width),this.ctx.font=this.style.font.string,this.ctx.fillStyle=r,this.ctx.textAlign=s,this.ctx.textBaseline="middle",i=0;i<l;++i)this.ctx.fillText(this.lines[i],Math.round(t)+this.style.padding.left,Math.round(e)+this.style.padding.top,Math.round(this.textRect.width)),e+=h},this.drawLabel=function(){a.beginPath(),this.ctx.fillRect(this.ctx,Math.round(this.labelRect.x),Math.round(this.labelRect.y),Math.round(this.labelRect.width),Math.round(this.labelRect.height),this.style.borderRadius),this.ctx.closePath(),this.style.backgroundColor&&(this.ctx.fillStyle=this.style.backgroundColor||"black",this.ctx.fill()),this.style.borderColor&&this.style.borderWidth&&(this.ctx.strokeStyle=this.style.borderColor,this.ctx.lineWidth=this.style.borderWidth,this.ctx.lineJoin="miter",this.ctx.stroke())},this.ccw=function(t,e,i){return(i.y-t.y)*(e.x-t.x)>(e.y-t.y)*(i.x-t.x)},this.intersects=function(t,e,i,s){return this.ccw(t,i,s)!==this.ccw(e,i,s)&&this.ccw(t,e,i)!==this.ccw(t,e,s)},this.drawLine=function(){this.ctx.save(),this.ctx.strokeStyle=this.style.lineColor,this.ctx.lineWidth=this.style.lineWidth,this.ctx.lineJoin="miter",this.ctx.beginPath(),this.ctx.moveTo(this.center.anchor.x,this.center.anchor.y),this.ctx.lineTo(this.center.copy.x,this.center.copy.y),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(this.center.copy.x,this.center.copy.y);const t=this.textRect.width+this.style.padding.width,e=this.intersects(this.textRect,{x:this.textRect.x+this.textRect.width,y:this.textRect.y+this.textRect.height},this.center.copy,{x:this.textRect.x,y:this.textRect.y+this.textRect.height/2});this.ctx.lineTo(this.textRect.x+(e?t:0),this.textRect.y+this.textRect.height/2),this.ctx.stroke(),this.ctx.restore()},this.draw=function(){this.drawLabel(),this.drawText()},this.update=function(t,e,i){this.center=s(t,this.stretch);for(var r=!1;!r;){this.textRect=this.computeTextRect(),this.labelRect=this.computeLabelRect();var n=this.getPoints();r=!0;for(var a=0;a<i;++a){var o=e[a][l];if(o)for(var c=o.getPoints(),d=0;d<n.length;++d){if(o.containsPoint(n[d])){r=!1;break}if(this.containsPoint(c[d])){r=!1;break}}}r||(this.center=h(this.center,1))}}};t.defaults.plugins.outlabels=i;var a=i.LABEL_KEY;return{id:"outlabels",resize:function(t){t.sizeChanged=!0},afterUpdate:t=>{const e=t._metasets[0].controller;var s=e.getMeta(),h=t.options.zoomOutPercentage||i.zoomOutPercentage;e.outerRadius*=1-h/100,e.innerRadius*=1-h/100,e.updateElements(s.data,0,s.data.length,"resize")},afterDatasetUpdate:function(t,e,i){var s,h,r,l,o,c,d=t.config.data.labels,u=t.data.datasets[e.index],x=function(t,e){var i=t.outlabels;return!1===i?null:(!0===i&&(i={}),Object.assign({},{},e,i))}(u,i),f=x&&x.display,y=e.meta.data||[],g=t.ctx;for(g.save(),c=0;c<y.length;++c){if(h=(s=y[c])[a],r=u.data[c]/e.meta.total,l=null,f&&s&&!s.hidden)try{o={chart:t,dataIndex:c,dataset:u,labels:d,datasetIndex:e.index,percent:r},l=new n(s,c,g,x,o)}catch(t){l=null}h&&l&&!t.sizeChanged&&h.label===l.label&&h.encodedText===l.encodedText&&(l.offset=h.offset),s[a]=l}g.restore(),t.sizeChanged=!1},afterDatasetDraw:function(t,e){for(var i,s,h=e.meta.data||[],r=t.ctx,l=0;l<2*h.length;++l)(s=(i=h[l<h.length?l:l-h.length])[a])&&(l<h.length?(s.update(i,h,l),s.drawLine(r)):s.draw(r))}}}));
