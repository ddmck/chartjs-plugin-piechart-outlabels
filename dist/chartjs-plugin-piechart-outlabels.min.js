/*!
 * chartjs-plugin-piechart-outlabels v0.1.3
 * http://www.chartjs.org
 * (c) 2017-2022 chartjs-plugin-piechart-outlabels contributors
 * Released under the MIT license
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("chart.js")):"function"==typeof define&&define.amd?define(["chart.js"],e):(t="undefined"!=typeof globalThis?globalThis:t||self).ChartPieChartOutlabels=e(t.Chart)}(this,(function(t){"use strict";var e={LABEL_KEY:"$outlabels",backgroundColor:function(t){return t.dataset.backgroundColor},borderColor:function(t){return t.dataset.backgroundColor},lineColor:function(t){return t.dataset.backgroundColor},borderRadius:0,borderWidth:0,lineWidth:2,color:"white",display:!0,font:{family:void 0,size:void 0,style:void 0,weight:null,maxSize:null,minSize:null,resizable:!0},lineHeight:1.2,padding:{top:4,right:4,bottom:4,left:4},textAlign:"center",stretch:40,text:"%l %p",zoomOutPercentage:50,percentPrecision:1,valuePrecision:3},i=function(){t.defaults.outlabeledDoughnut=t.defaults.doughnut,t.defaults.outlabeledPie=t.defaults.pie;class i extends t.PieController{update(t){super.update(t);var i=this.getMeta(),s=this.chart.options.zoomOutPercentage||e.zoomOutPercentage;this.outerRadius*=1-s/100,this.innerRadius*=1-s/100,this.updateElements(i.data,0,i.data.length,"resize")}}class s extends t.DoughnutController{update(t){super.update(t);var i=this.getMeta(),s=this.chart.options.zoomOutPercentage||e.zoomOutPercentage;this.outerRadius*=1-s/100,this.innerRadius*=1-s/100,this.updateElements(i.data,0,i.data.length,"resize")}}i.id="outlabeledPie",s.id="outlabeledDoughnut",t.Chart.register(i),t.Chart.register(s)},s=function(t,e){var i=(t.startAngle+t.endAngle)/2,s=Math.cos(i),h=Math.sin(i),r=t.outerRadius,n=r+e;return{x:t.x+s*n,y:t.y+h*n,d:n,arc:t,anchor:{x:t.x+s*r,y:t.y+h*r},copy:{x:t.x+s*n,y:t.y+h*n}}},h=function(t,e){var i=t.arc,s=t.d,h=(i.startAngle+i.endAngle)/2,r=Math.cos(h),n=Math.sin(h);return s+=e,{x:i.x+r*s,y:i.y+n*s,d:s,arc:i,anchor:t.anchor,copy:{x:i.x+r*s,y:i.y+n*s}}},r=t.Chart.helpers,n=e.LABEL_KEY,l=function(i,l,a,o,c){var d=t.Chart.helpers.resolve;if(!d([o.display,!0],c,l))throw new Error("Label display property is set to false.");var f=c.dataset.data[l],u=c.labels[l],x=d([o.text,e.text],c,l);((x=x.replace(/%l/gi,u)).match(/%v\.?(\d*)/gi)||[]).map((function(t){var i=t.replace(/%v\./gi,"");return i.length?+i:o.valuePrecision||e.valuePrecision})).forEach((function(t){x=x.replace(/%v\.?(\d*)/i,f.toFixed(t))})),(x.match(/%p\.?(\d*)/gi)||[]).map((function(t){var i=t.replace(/%p\./gi,"");return i.length?+i:o.percentPrecision||e.percentPrecision})).forEach((function(t){x=x.replace(/%p\.?(\d*)/i,(100*c.percent).toFixed(t)+"%")}));var g=x.match(/[^\r\n]+/g);if(!g||!g.length)throw new Error("No text to show.");for(var y=0;y<g.length;++y)g[y]=g[y].trim();this.init=function(t,s){this.encodedText=o.text,this.text=t,this.lines=s,this.label=u,this.value=f,this.ctx=a,this.style={backgroundColor:d([o.backgroundColor,e.backgroundColor,"black"],c,l),borderColor:d([o.borderColor,e.borderColor,"black"],c,l),borderRadius:d([o.borderRadius,0],c,l),borderWidth:d([o.borderWidth,0],c,l),lineWidth:d([o.lineWidth,2],c,l),lineColor:d([o.lineColor,e.lineColor,"black"],c,l),color:d([o.color,"white"],c,l),font:r.parseFont(d([o.font,{resizable:!0}]),a.canvas.style.height.slice(0,-2)),padding:r.toPadding(d([o.padding,0],c,l)),textAlign:d([o.textAlign,"left"],c,l)},this.stretch=d([o.stretch,40],c,l),this.size=r.textSize(a,this.lines,this.style.font),this.offsetStep=this.size.width/20,this.offset={x:0,y:0},this.predictedOffset=this.offset;var h=-(i.startAngle+i.endAngle)/2/Math.PI,n=Math.abs(h-Math.trunc(h));n>.45&&n<.55?this.predictedOffset.x=0:h<=.45&&h>=-.45?this.predictedOffset.x=this.size.width/2:h>=-1.45&&h<=-.55&&(this.predictedOffset.x=-this.size.width/2)},this.init(x,g),this.computeLabelRect=function(){var t=this.textRect.width+2*this.style.borderWidth+2*this.style.padding.left,e=this.textRect.height+2*this.style.borderWidth;return{x:this.textRect.x-this.style.borderWidth,y:this.textRect.y-this.style.borderWidth,width:t,height:e}};this.computeTextRect=function(){const t=this.center.x-this.center.copy.x<0?-60:60;return{x:this.center.x-this.size.width/2-this.style.padding.left+t,y:this.center.y-this.size.height/2-this.style.padding.top,width:this.size.width,height:this.size.height+this.style.padding.height}},this.getPoints=function(){return[{x:this.labelRect.x,y:this.labelRect.y},{x:this.labelRect.x+this.labelRect.width,y:this.labelRect.y},{x:this.labelRect.x+this.labelRect.width,y:this.labelRect.y+this.labelRect.height},{x:this.labelRect.x,y:this.labelRect.y+this.labelRect.height}]},this.containsPoint=function(t,e){return e||(e=5),this.labelRect.x-e<=t.x&&t.x<=this.labelRect.x+this.labelRect.width+e&&this.labelRect.y-e<=t.y&&t.y<=this.labelRect.y+this.labelRect.height+e},this.drawText=function(){var t,e,i,s=this.style.textAlign,h=this.style.font.lineHeight,r=this.style.color,n=this.lines.length;if(n&&r)for(t=this.textRect.x,e=this.textRect.y+h/2,"center"===s?t+=this.textRect.width/2:"end"!==s&&"right"!==s||(t+=this.textRect.width),this.ctx.font=this.style.font.string,this.ctx.fillStyle=r,this.ctx.textAlign=s,this.ctx.textBaseline="middle",i=0;i<n;++i)this.ctx.fillText(this.lines[i],Math.round(t)+this.style.padding.left,Math.round(e)+this.style.padding.top,Math.round(this.textRect.width)),e+=h},this.drawLabel=function(){a.beginPath(),this.ctx.fillRect(this.ctx,Math.round(this.labelRect.x),Math.round(this.labelRect.y),Math.round(this.labelRect.width),Math.round(this.labelRect.height),this.style.borderRadius),this.ctx.closePath(),this.style.backgroundColor&&(this.ctx.fillStyle=this.style.backgroundColor||"black",this.ctx.fill()),this.style.borderColor&&this.style.borderWidth&&(this.ctx.strokeStyle=this.style.borderColor,this.ctx.lineWidth=this.style.borderWidth,this.ctx.lineJoin="miter",this.ctx.stroke())},this.ccw=function(t,e,i){return(i.y-t.y)*(e.x-t.x)>(e.y-t.y)*(i.x-t.x)},this.intersects=function(t,e,i,s){return this.ccw(t,i,s)!==this.ccw(e,i,s)&&this.ccw(t,e,i)!==this.ccw(t,e,s)},this.drawLine=function(){this.ctx.save(),this.ctx.strokeStyle=this.style.lineColor,this.ctx.lineWidth=this.style.lineWidth,this.ctx.lineJoin="miter",this.ctx.beginPath(),this.ctx.moveTo(this.center.anchor.x,this.center.anchor.y),this.ctx.lineTo(this.center.copy.x,this.center.copy.y),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(this.center.copy.x,this.center.copy.y);const t=this.textRect.width+this.style.padding.width,e=this.intersects(this.textRect,{x:this.textRect.x+this.textRect.width,y:this.textRect.y+this.textRect.height},this.center.copy,{x:this.textRect.x,y:this.textRect.y+this.textRect.height/2});this.ctx.lineTo(this.textRect.x+(e?t:0),this.textRect.y+this.textRect.height/2),this.ctx.stroke(),this.ctx.restore()},this.draw=function(){this.drawLabel(),this.drawText()},this.update=function(t,e,i){this.center=s(t,this.stretch),this.moveLabelToOffset(),this.center.x+=this.offset.x,this.center.y+=this.offset.y;for(var r=!1;!r;){this.textRect=this.computeTextRect(),this.labelRect=this.computeLabelRect();var l=this.getPoints();r=!0;for(var a=0;a<i;++a){var o=e[a][n];if(o)for(var c=o.getPoints(),d=0;d<l.length;++d){if(o.containsPoint(l[d])){r=!1;break}if(this.containsPoint(c[d])){r=!1;break}}}r||(this.center=h(this.center,1),this.center.x+=this.offset.x,this.center.y+=this.offset.y)}},this.moveLabelToOffset=function(){this.predictedOffset.x<=0&&this.offset.x>this.predictedOffset.x?(this.offset.x-=this.offsetStep,this.offset.x<=this.predictedOffset.x&&(this.offset.x=this.predictedOffset.x)):this.predictedOffset.x>=0&&this.offset.x<this.predictedOffset.x&&(this.offset.x+=this.offsetStep,this.offset.x>=this.predictedOffset.x&&(this.offset.x=this.predictedOffset.x))}},a=t.Chart.helpers,o=a.merge(a,{toFontString:function(t){return!t||a.isNullOrUndef(t.size)||a.isNullOrUndef(t.family)?null:(t.style?t.style+" ":"")+(t.weight?t.weight+" ":"")+t.size+"px "+t.family},textSize:function(t,e,i){var s,h=[].concat(e),r=h.length,n=t.font,l=0;for(t.font=i.string,s=0;s<r;++s)l=Math.max(t.measureText(h[s]).width,l);return t.font=n,{height:r*i.lineHeight,width:l}},parseFont:function(e,i){var s=t.Chart.defaults,h=a.valueOrDefault(e.size,s.defaultFontSize);e.resizable&&(h=this.adaptTextSizeToHeight(i,e.minSize,e.maxSize));var r={family:a.valueOrDefault(e.family,s.defaultFontFamily),lineHeight:a.toLineHeight(e.lineHeight,h),size:h,style:a.valueOrDefault(e.style,s.defaultFontStyle),weight:a.valueOrDefault(e.weight,null),string:""};return r.string=a.toFontString(r),r},adaptTextSizeToHeight:function(t,e,i){var s=t/100*2.5;return e&&s<e?e:i&&s>i?i:s}});i(),t.defaults.plugins.outlabels=e;var c=e.LABEL_KEY;return{id:"outlabels",resize:function(t){t.sizeChanged=!0},afterDatasetUpdate:function(t,e,i){var s,h,r,n,a,d,f=t.config.data.labels,u=t.data.datasets[e.index],x=function(t,e){var i=t.outlabels;return!1===i?null:(!0===i&&(i={}),o.merge({},[e,i]))}(u,i),g=x&&x.display,y=e.meta.data||[],p=t.ctx;for(p.save(),d=0;d<y.length;++d){if(h=(s=y[d])[c],r=u.data[d]/e.meta.total,n=null,g&&s&&!s.hidden)try{a={chart:t,dataIndex:d,dataset:u,labels:f,datasetIndex:e.index,percent:r},n=new l(s,d,p,x,a)}catch(t){n=null}h&&n&&!t.sizeChanged&&h.label===n.label&&h.encodedText===n.encodedText&&(n.offset=h.offset),s[c]=n}p.restore(),t.sizeChanged=!1},afterDatasetDraw:function(t,e){for(var i,s,h=e.meta.data||[],r=t.ctx,n=0;n<2*h.length;++n)(s=(i=h[n<h.length?n:n-h.length])[c])&&(n<h.length?(s.update(i,h,n),s.drawLine(r)):s.draw(r))}}}));
